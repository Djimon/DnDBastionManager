<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Bastion Manager</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="app-container">
        <!-- HEADER (Global) -->
        <header class="app-header">
            <div class="header-left">
                <h1 data-i18n="app.title">D&D Bastion Manager</h1>
            </div>
            <div class="header-center" id="session-info">
                <span class="session-name">[No Session]</span> |
                <span class="turn-counter">Turn: 0</span>
            </div>
            <div class="header-right">
                <div class="header-lang">
                    <label for="language-select" data-i18n="header.language">Sprache</label>
                    <select id="language-select" class="lang-select"></select>
                </div>
                <button class="btn btn-small" onclick="saveSession()" data-i18n="header.save">üíæ Save</button>
                <button class="btn btn-small" onclick="loadSession()" data-i18n="header.load">üìÇ Load</button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main class="app-main">

            <!-- ===== VIEW 1: SESSION WIZARD ===== -->
            <div id="view-1" class="view active">
                <div class="wizard-container">
                    <h2 data-i18n="wizard.title">Neue Session erstellen</h2>
                    
                    <div class="wizard-form">
                        <!-- Session Info -->
                        <fieldset>
                            <legend data-i18n="wizard.session_info">Session-Informationen</legend>
                            <div class="form-group">
                                <label for="dm-name" data-i18n="wizard.dm_name">DM-Name:</label>
                                <input type="text" id="dm-name" placeholder="z.B. 'Djih'" data-i18n-placeholder="wizard.dm_placeholder" />
                            </div>
                            <div class="form-group">
                                <label for="session-name" data-i18n="wizard.session_name">Session-Name:</label>
                                <input type="text" id="session-name" placeholder="z.B. 'Campaign Session 1'" data-i18n-placeholder="wizard.session_placeholder" />
                            </div>
                        </fieldset>

                        <!-- Bastion Config -->
                        <fieldset>
                            <legend data-i18n="wizard.bastion_config">Bastion-Konfiguration</legend>
                            <div class="form-group">
                                <label for="bastion-name" data-i18n="wizard.bastion_name">Bastion-Name:</label>
                                <input type="text" id="bastion-name" placeholder="z.B. 'Shadowkeep'" data-i18n-placeholder="wizard.bastion_name_placeholder" />
                            </div>
                            <div class="form-group">
                                <label for="bastion-location" data-i18n="wizard.bastion_location">Standort/Region:</label>
                                <input type="text" id="bastion-location" placeholder="z.B. 'Waterdeep, Dock Ward'" data-i18n-placeholder="wizard.bastion_location_placeholder" />
                            </div>
                            <div class="form-group">
                                <label for="bastion-description" data-i18n="wizard.bastion_description">Beschreibung:</label>
                                <textarea id="bastion-description" placeholder="Narrative Beschreibung der Bastion..." data-i18n-placeholder="wizard.bastion_description_placeholder"></textarea>
                            </div>
                        </fieldset>

                        <!-- Player Registry -->
                        <fieldset>
                            <legend data-i18n="wizard.players_register">Spieler registrieren</legend>
                            <div id="players-list" class="players-list">
                                <!-- Dynamic: filled by JS -->
                            </div>
                            <div class="form-group">
                                <label for="player-name" data-i18n="wizard.player_name">Character-Name:</label>
                                <input type="text" id="player-name" placeholder="Character Name" data-i18n-placeholder="wizard.player_name_placeholder" />
                            </div>
                            <div class="form-group">
                                <label for="player-class" data-i18n="wizard.player_class">Klasse:</label>
                                <input type="text" id="player-class" placeholder="z.B. Rogue, Wizard" data-i18n-placeholder="wizard.player_class_placeholder" />
                            </div>
                            <div class="form-group">
                                <label for="player-level" data-i18n="wizard.player_level">Level (optional):</label>
                                <input type="number" id="player-level" placeholder="5" min="1" max="20" data-i18n-placeholder="wizard.player_level_placeholder" />
                            </div>
                            <button class="btn btn-secondary" onclick="addPlayer()" data-i18n="wizard.add_player">+ Add Player</button>
                        </fieldset>

                        <button class="btn btn-primary" onclick="createSession()" data-i18n="wizard.create_session">Neue Session erstellen</button>
                    </div>
                </div>
            </div>

            <!-- ===== VIEW 2: BUILD QUEUE ===== -->
            <div id="view-2" class="view">
                <div class="build-container">
                    <div class="build-header">
                        <h2 data-i18n="build.title">Bastion bauen</h2>
                        <button class="btn btn-small" onclick="switchView(3)" data-i18n="build.back_to_view3">‚Üê Zur√ºck zu View 3</button>
                    </div>

                    <div class="build-grid">
                        <!-- LEFT: Facility Catalog -->
                        <div class="build-catalog">
                            <h3 data-i18n="build.catalog_title">Facility Katalog</h3>

                            <div class="filters">
                                <input type="text" id="facility-search" placeholder="Suche..." data-i18n-placeholder="build.search_placeholder" />
                                <select id="filter-pack">
                                    <option value="" data-i18n="build.filter_all_packs">Alle Packs</option>
                                </select>
                                <select id="filter-tier">
                                    <option value="" data-i18n="build.filter_all_tiers">Alle Tiers</option>
                                </select>
                            </div>

                            <div id="facility-list" class="facility-catalog-list">
                                <div class="placeholder-item">
                                    <strong>[Facility 1]</strong>
                                    <p>250g | 1 Turn | Slots: 1</p>
                                    <button class="btn btn-small" onclick="addToQueue(1)">+ Add to Queue</button>
                                </div>
                                <div class="placeholder-item">
                                    <strong>[Facility 2]</strong>
                                    <p>500g | 2 Turns | Slots: 2</p>
                                    <button class="btn btn-small" onclick="addToQueue(2)">+ Add to Queue</button>
                                </div>
                                <div class="placeholder-item">
                                    <strong>[Facility 3]</strong>
                                    <p>1000g | 3 Turns | Slots: 1</p>
                                    <button class="btn btn-small" onclick="addToQueue(3)">+ Add to Queue</button>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT: Build Queue -->
                        <div class="build-queue">
                            <h3 data-i18n="build.queue_title">Build Queue</h3>
                            
                            <div id="queue-list" class="queue-items">
                                <div class="queue-item">
                                    <div class="queue-item-info">
                                        <strong>[Facility 1]</strong>
                                        <p>250g | 1 Turn</p>
                                    </div>
                                    <button class="btn btn-danger" onclick="removeFromQueue(1)">Remove</button>
                                </div>
                            </div>

                            <div class="queue-summary">
                                <p><span data-i18n="build.total_cost">Total Cost:</span> <strong id="total-cost">250g</strong></p>
                                <p><span data-i18n="build.remaining_budget">Remaining Budget:</span> <strong id="remaining-budget">-250g</strong></p>
                            </div>

                            <button class="btn btn-primary" onclick="startBuilding()" data-i18n="build.start_building">Bauen starten</button>
                            <button class="btn btn-secondary" onclick="clearQueue()" data-i18n="build.clear_queue">Queue l√∂schen</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== VIEW 3: TURN CONSOLE ===== -->
            <div id="view-3" class="view">
                <div class="turn-console">
                    <!-- TOP: Session Info Bar (already in header) -->

                    <div class="console-grid">
                        <!-- LEFT: Facility List -->
                        <aside class="facilities-sidebar">
                            <h3 data-i18n="facility.list_title">Facilities</h3>
                            <div id="facilities-left-panel" class="facilities-list">
                                <div class="facility-list-item" onclick="selectFacility(1)">
                                    <span class="facility-name">Garden ‚òÖ</span>
                                    <span class="facility-status">[idle]</span>
                                </div>
                                <div class="facility-list-item" onclick="selectFacility(2)">
                                    <span class="facility-name">Workshop ‚òÖ‚òÖ‚òÖ</span>
                                    <span class="facility-status">[upgrading]</span>
                                </div>
                                <div class="facility-list-item" onclick="selectFacility(3)">
                                    <span class="facility-name">Whisper Office ‚òÖ‚òÖ</span>
                                    <span class="facility-status">[busy]</span>
                                </div>
                            </div>

                            <div class="sidebar-actions">
                                <button class="btn btn-secondary" onclick="switchView(2)" data-i18n="turn.build_new">+ New Facility</button>
                                <button class="btn btn-secondary" onclick="openNPCModal()" data-i18n="turn.manage_npcs">üë• Manage NPCs</button>
                            </div>
                        </aside>

                        <!-- CENTER: Facility Detail Panel (Tabs) -->
                        <section class="facility-detail-panel">
                            <div id="facility-empty" class="facility-empty" data-i18n="facility.select_prompt">Bitte Facility w√§hlen</div>

                            <div id="facility-main" class="facility-main hidden">
                                <div class="tabs">
                                    <button class="tab-btn active" onclick="switchTab('details')" data-i18n="tabs.details">Details</button>
                                    <button class="tab-btn" onclick="switchTab('npcs')" data-i18n="tabs.npcs">NPCs</button>
                                    <button class="tab-btn" onclick="switchTab('orders')" data-i18n="tabs.orders">Orders</button>
                                </div>

                                <!-- TAB: Details -->
                                <div id="tab-details" class="tab-content active">
                                    <h3 data-i18n="details.title">Facility Details</h3>
                                    <div class="detail-info">
                                        <p><strong data-i18n="details.name">Name:</strong> <span id="detail-name">[Facility Name]</span></p>
                                        <p><strong data-i18n="details.description">Beschreibung:</strong> <span id="detail-desc">[Placeholder]</span></p>
                                        <p><strong data-i18n="details.tier">Tier:</strong> <span id="detail-tier">‚òÖ‚òÖ</span></p>
                                        <p><strong data-i18n="details.slots">NPC Slots:</strong> <span id="detail-slots">2/3</span><span id="detail-slot-bubbles" class="slot-bubbles"></span></p>
                                        <p><strong data-i18n="details.status">Status:</strong> <span id="detail-status">idle</span></p>
                                    </div>

                                    <div class="upgrade-section">
                                        <h4 data-i18n="upgrade.title">Upgrade</h4>
                                        <p id="upgrade-info">Cost: 500g | Duration: 2 Turns</p>
                                        <button id="upgrade-button" class="btn btn-secondary" onclick="startUpgrade()" data-i18n="upgrade.button">Upgrade</button>
                                    </div>
                                </div>

                                <!-- TAB: NPCs -->
                                <div id="tab-npcs" class="tab-content">
                                    <h3 data-i18n="npcs.assigned_title">Assigned NPCs</h3>
                                    <table class="npcs-table">
                                        <thead>
                                            <tr>
                                                <th data-i18n="npcs.table_name">Name</th>
                                                <th data-i18n="npcs.table_profession">Profession</th>
                                                <th data-i18n="npcs.table_level">Level</th>
                                                <th data-i18n="npcs.table_xp">XP</th>
                                                <th data-i18n="npcs.table_upkeep">Upkeep</th>
                                                <th data-i18n="npcs.table_action">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="npc-assigned-body"></tbody>
                                    </table>
                                    <p id="npc-assigned-empty" class="text-muted hidden" data-i18n="npcs.none_assigned">No NPCs assigned.</p>
                                    <button class="btn btn-secondary" onclick="openHireModal()" data-i18n="npcs.hire_button">+ Hire NPC</button>
                                </div>

                                <!-- TAB: Orders -->
                                <div id="tab-orders" class="tab-content">
                                    <h3 data-i18n="orders.title">Orders</h3>

                                    <div class="order-new">
                                        <h4 data-i18n="orders.new_title">Neue Order</h4>
                                        <div class="form-group">
                                            <label for="order-npc-select" data-i18n="orders.npc_label">NPC:</label>
                                            <select id="order-npc-select"></select>
                                        </div>
                                        <div class="form-group">
                                            <label for="order-select" data-i18n="orders.order_label">Order:</label>
                                            <select id="order-select"></select>
                                        </div>
                                        <button class="btn btn-primary" onclick="startOrder()" data-i18n="orders.start">Order starten</button>
                                        <p id="order-new-hint" class="text-muted"></p>
                                    </div>

                                    <div class="orders-active">
                                        <div class="orders-header">
                                            <h4 data-i18n="orders.active_title">Aktive Orders</h4>
                                            <button id="orders-evaluate-all" class="btn btn-secondary btn-small" onclick="evaluateAllReady()" data-i18n="orders.evaluate_all">Alle auswerten</button>
                                        </div>
                                        <div id="orders-list" class="orders-list"></div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <aside id="inventory-panel" class="inventory-panel hidden">
                            <h4 data-i18n="inventory.title">Inventar</h4>
                            <div id="inventory-wallet" class="inventory-wallet"></div>
                            <div id="inventory-groups" class="inventory-groups"></div>
                            <p id="inventory-empty" class="text-muted hidden" data-i18n="inventory.empty">Keine Items im Inventar.</p>
                        </aside>
                    </div>

                    <!-- BOTTOM: Turn Controls & Log -->
                    <footer class="turn-controls">
                        <div class="controls-buttons">
                            <button class="btn btn-small btn-secondary" onclick="validatePacks()" data-i18n="turn.validate_packs">Validate Packs</button>
                            <button class="btn btn-primary" onclick="advanceTurn()" data-i18n="turn.advance_turn">‚è≠Ô∏è Advance Turn</button>
                            <button class="btn btn-secondary" onclick="switchView(2)" data-i18n="turn.build_new">+ Build New Facility</button>
                            <button class="btn btn-secondary" onclick="openNPCModal()" data-i18n="turn.manage_npcs">üë• Manage NPCs</button>
                            <button class="btn btn-success" onclick="saveSession()" data-i18n="turn.save_session">üíæ Save Session</button>
                        </div>

                        <div class="treasury-adjust">
                            <label class="treasury-label" data-i18n="treasury.title">Treasury</label>
                            <div class="treasury-row">
                                <select id="treasury-mode" class="treasury-select">
                                    <option value="add" data-i18n="treasury.mode_add">Add</option>
                                    <option value="set" data-i18n="treasury.mode_set">Set</option>
                                </select>
                                <input type="number" id="treasury-amount" class="treasury-input" min="0" step="1" placeholder="0" />
                                <select id="treasury-currency" class="treasury-select"></select>
                                <button class="btn btn-secondary btn-small" onclick="adjustTreasury()" data-i18n="treasury.apply">Apply</button>
                            </div>
                        </div>

                        <div class="turn-log">
                            <h4 data-i18n="turn.log_title">Turn Log</h4>
                            <div id="log-content" class="log-messages">
                                <p class="log-entry success">‚úì Garden +20 gold</p>
                                <p class="log-entry event">‚ö† Office agent killed (event)</p>
                                <p class="log-entry success">‚úì Shrine +1 reputation</p>
                                <p class="log-entry fail">‚úó Workshop craft failed</p>
                            </div>
                        </div>
                    </footer>
                </div>
            </div>

        </main>
        <!-- GLOBAL DEV FOOTER -->
        <footer class="global-dev-footer">
            <button class="dev-validate-btn" onclick="validatePacks()" data-i18n="dev.validate_packs">Validate Packs</button>
        </footer>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- NPC Management Modal -->
    <div id="npc-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="modal.npc_title">NPC Management</h3>
                <button class="modal-close" onclick="closeModal('npc-modal')">√ó</button>
            </div>

            <div class="modal-tabs">
                <button class="modal-tab-btn active" data-modal-tab="hired" onclick="switchModalTab('hired')" data-i18n="modal.tab_hired">Angestellt</button>
                <button class="modal-tab-btn" data-modal-tab="hire" onclick="switchModalTab('hire')" data-i18n="modal.tab_hire">Neue Anstellung</button>
                <button class="modal-tab-btn" data-modal-tab="reserve" onclick="switchModalTab('reserve')" data-i18n="modal.tab_reserve">Reserve</button>
            </div>

            <!-- Hired NPCs -->
            <div id="modal-tab-hired" class="modal-tab-content active">
                <table class="npcs-table">
                    <thead>
                        <tr>
                            <th data-i18n="npcs.table_name">Name</th>
                            <th data-i18n="modal.hired_table_facility">Facility</th>
                            <th data-i18n="npcs.table_profession">Profession</th>
                            <th data-i18n="npcs.table_level">Level</th>
                            <th data-i18n="npcs.table_xp">XP</th>
                            <th data-i18n="modal.hired_table_upkeep">Upkeep/Turn</th>
                            <th data-i18n="npcs.table_action">Action</th>
                        </tr>
                    </thead>
                    <tbody id="modal-npcs-body"></tbody>
                </table>
                <p id="modal-total-upkeep" class="text-muted" data-i18n="modal.total_upkeep">Total Upkeep: 0g</p>
            </div>

            <!-- Hire New NPC -->
            <div id="modal-tab-hire" class="modal-tab-content">
                <div class="form-group">
                    <label for="hire-name" data-i18n="modal.hire_name">NPC-Name:</label>
                    <input type="text" id="hire-name" placeholder="z.B. 'Rook'" data-i18n-placeholder="modal.hire_name_placeholder" />
                </div>
                <div class="form-group">
                    <label for="hire-profession" data-i18n="modal.hire_profession">Profession:</label>
                    <select id="hire-profession">
                        <option value="spy" data-i18n="modal.profession_spy">Spy</option>
                        <option value="gardener" data-i18n="modal.profession_gardener">Gardener</option>
                        <option value="craftsman" data-i18n="modal.profession_craftsman">Craftsman</option>
                        <option value="custom" data-i18n="modal.profession_custom">Custom</option>
                    </select>
                </div>
                <div class="form-group hidden" id="hire-profession-custom-wrap">
                    <label for="hire-profession-custom" data-i18n="modal.profession_custom_label">Custom Profession:</label>
                    <input type="text" id="hire-profession-custom" placeholder="e.g. Alchemist" data-i18n-placeholder="modal.profession_custom_placeholder" />
                </div>
                <div class="form-group">
                    <label for="hire-level" data-i18n="modal.hire_level">Level:</label>
                    <select id="hire-level">
                        <option value="1" data-i18n="modal.level_apprentice">Apprentice</option>
                        <option value="2" data-i18n="modal.level_experienced">Experienced</option>
                        <option value="3" data-i18n="modal.level_master">Master</option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-i18n="modal.hire_upkeep">Upkeep pro Turn:</label>
                    <div class="form-row">
                        <input type="number" id="hire-upkeep-amount" min="0" step="1" placeholder="0" />
                        <select id="hire-upkeep-currency"></select>
                    </div>
                    <p id="hire-upkeep-hint" class="text-muted"></p>
                </div>
                <div class="form-group">
                    <label for="hire-assign-facility" data-i18n="modal.hire_facility">Facility:</label>
                    <select id="hire-assign-facility"></select>
                </div>
                <button class="btn btn-primary" onclick="hireNPC()" data-i18n="modal.hire_button">Hire</button>
            </div>

            <!-- Reserve -->
            <div id="modal-tab-reserve" class="modal-tab-content">
                <table class="npcs-table">
                    <thead>
                        <tr>
                            <th data-i18n="npcs.table_name">Name</th>
                            <th data-i18n="npcs.table_profession">Profession</th>
                            <th data-i18n="npcs.table_level">Level</th>
                            <th data-i18n="npcs.table_xp">XP</th>
                            <th data-i18n="modal.hired_table_upkeep">Upkeep/Turn</th>
                            <th data-i18n="npcs.table_action">Action</th>
                        </tr>
                    </thead>
                    <tbody id="modal-reserve-body"></tbody>
                </table>
                <p id="modal-reserve-empty" class="text-muted hidden" data-i18n="npcs.none_reserve">No NPCs in reserve.</p>
            </div>
        </div>
    </div>

    <!-- Load Session Modal -->
    <div id="load-session-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 data-i18n="load_session.title">Load Session</h3>
                <button class="modal-close" onclick="closeModal('load-session-modal')">√ó</button>
            </div>

            <div id="sessions-list" class="sessions-list">
                <p class="placeholder" data-i18n="load_session.loading">Loading sessions...</p>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('load-session-modal')" data-i18n="load_session.cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/js/i18n.js"></script>
    <script src="/js/app_state.js"></script>
    <script src="/js/app_api.js"></script>
    <script src="/js/view_build.js"></script>
    <script src="/js/view_turn.js"></script>

    <div id="toast-container" class="toast-container"></div>
</body>
</html>
