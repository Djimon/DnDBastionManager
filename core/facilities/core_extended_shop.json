{
  "pack_id": "core.extended.shop",
  "name": "Storehouse & Trading Post",
  "version": 1,
  "author": "Djih",

  "custom_mechanics": [
    {
      "name": "Market Tracker",
      "type": "market_tracker",
      "config": {
        "categories": [
          {"name": "weapons", "start": 11},
          {"name": "armor", "start": 7},
          {"name": "potions", "start": -3},
          {"name": "tools", "start": 0},
          {"name": "jewelry", "start": -5}
        ],
        "price_range": [-0.20, 0.20]
      }
    },
    {
      "name": "Shop Trading",
      "type": "formula_engine",
      "config": {
        "inputs": [
          {"name": "weapons_market", "source": "market", "default": "weapons", "label": "Weapons Market (%)"},
          {"name": "armor_market", "source": "market", "default": "armor", "label": "Armor Market (%)"},
          {"name": "potions_market", "source": "market", "default": "potions", "label": "Potions Market (%)"},
          {"name": "tools_market", "source": "market", "default": "tools", "label": "Tools Market (%)"},
          {"name": "jewelry_market", "source": "market", "default": "jewelry", "label": "jewelry Market (%)"},
          
          {"name": "weapons_sell", "source": "prompt", "label": "SELL Weapons at markup (%, 0=skip)"},
          {"name": "armor_sell", "source": "prompt", "label": "SELL Armor at markup (%, 0=skip)"},
          {"name": "potions_sell", "source": "prompt", "label": "SELL Potions at markup (%, 0=skip)"},
          {"name": "tools_sell", "source": "prompt", "label": "SELL Tools at markup (%, 0=skip)"},
          {"name": "jewelry_sell", "source": "prompt", "label": "SELL jewelry at markup (%, 0=skip)"},
          
          {"name": "weapons_buy", "source": "prompt", "label": "BUY Weapons at discount (%, 0=skip)"},
          {"name": "armor_buy", "source": "prompt", "label": "BUY Armor at discount (%, 0=skip)"},
          {"name": "potions_buy", "source": "prompt", "label": "BUY Potions at discount (%, 0=skip)"},
          {"name": "tools_buy", "source": "prompt", "label": "BUY Tools at discount (%, 0=skip)"},
          {"name": "jewelry_buy", "source": "prompt", "label": "BUY jewelry at discount (%, 0=skip)"},
          
          {"name": "base_volume", "source": "fixed", "default": 100, "label": "Base Trade Volume (GP)"}
        ],
        "calculations": [
          {
            "name": "weapons_sell_profit",
            "conditions": [
              { "if": "weapons_sell > 0", "then_formula": "base_volume * (weapons_market - weapons_sell) / 100" },
              { "else": 0 }
            ]
          },
          {
            "name": "weapons_buy_cost",
            "conditions": [
              { "if": "weapons_buy > 0", "then_formula": "-base_volume * (weapons_market + weapons_buy) / 100" },
              { "else": 0 }
            ]
          },
          { "name": "weapons_total", "formula": "weapons_sell_profit + weapons_buy_cost" },

          {
            "name": "armor_sell_profit",
            "conditions": [
              { "if": "armor_sell > 0", "then_formula": "base_volume * (armor_market - armor_sell) / 100" },
              { "else": 0 }
            ]
          },
          {
            "name": "armor_buy_cost",
            "conditions": [
              { "if": "armor_buy > 0", "then_formula": "-base_volume * (armor_market + armor_buy) / 100" },
              { "else": 0 }
            ]
          },
          { "name": "armor_total", "formula": "armor_sell_profit + armor_buy_cost" },

          {
            "name": "potions_sell_profit",
            "conditions": [
              { "if": "potions_sell > 0", "then_formula": "base_volume * (potions_market - potions_sell) / 100" },
              { "else": 0 }
            ]
          },
          {
            "name": "potions_buy_cost",
            "conditions": [
              { "if": "potions_buy > 0", "then_formula": "-base_volume * (potions_market + potions_buy) / 100" },
              { "else": 0 }
            ]
          },
          { "name": "potions_total", "formula": "potions_sell_profit + potions_buy_cost" },

          {
            "name": "tools_sell_profit",
            "conditions": [
              { "if": "tools_sell > 0", "then_formula": "base_volume * (tools_market - tools_sell) / 100" },
              { "else": 0 }
            ]
          },
          {
            "name": "tools_buy_cost",
            "conditions": [
              { "if": "tools_buy > 0", "then_formula": "-base_volume * (tools_market + tools_buy) / 100" },
              { "else": 0 }
            ]
          },
          { "name": "tools_total", "formula": "tools_sell_profit + tools_buy_cost" },

          {
            "name": "jewelry_sell_profit",
            "conditions": [
              { "if": "jewelry_sell > 0", "then_formula": "base_volume * (jewelry_market - jewelry_sell) / 100" },
              { "else": 0 }
            ]
          },
          {
            "name": "jewelry_buy_cost",
            "conditions": [
              { "if": "jewelry_buy > 0", "then_formula": "-base_volume * (jewelry_market + jewelry_buy) / 100" },
              { "else": 0 }
            ]
          },
          { "name": "jewelry_total", "formula": "jewelry_sell_profit + jewelry_buy_cost" },

          {
            "name": "total_profit",
            "formula": "weapons_total + armor_total + potions_total + tools_total + jewelry_total"
          }
        ],
        
        "effects": [
          {"gold": "${total_profit}"}
        ]
      }
    }
  ],

  "facilities": [
    {
      "id": "core.shop:shop:t1",
      "name": "Storehouse",
      "description": "A modest trading post for buying and selling common goods.",
      "tier": 1,
      "parent": null,
      "build": {
        "cost": {"gold": 250},
        "duration_turns": 1
      },
      "npc_slots": 1,
      "npc_allowed_professions": ["merchant", "trader", "shopkeeper"],
      "npc_base_upkeep": {"silver": 5},

      "orders": [
        {
          "id": "trade_turn",
          "name": "Execute Trading Turn",
          "description": "Trade goods based on market conditions and your pricing strategy.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"log": "Trading completed. Shop Trading formula applied."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": 20},
                {"log": "Exceptional negotiations! Bonus profits from savvy deals."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -10},
                {"log": "Some deals fell through. Minor losses."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -30},
                {"log": "Catastrophic misjudgment! Major trading losses."}
              ]
            }
          }
        },
        {
          "id": "gather_market_intel",
          "name": "Gather Market Intelligence",
          "description": "Send scouts to observe market trends and competitor pricing.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -5},
                {"item": "market_report", "qty": 1},
                {"log": "Gathered useful market information."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -5},
                {"item": "detailed_market_report", "qty": 1},
                {"log": "Excellent intelligence! Discovered upcoming market shifts."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -5},
                {"log": "Market information unclear this week."}
              ]
            }
          }
        },
        {
          "id": "expand_inventory",
          "name": "Expand Inventory Capacity",
          "description": "Invest in storage to increase base trading volume.",
          "min_npc_level": 2,
          "duration_turns": 2,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -30},
                {"log": "Storage expanded. Base volume permanently increased."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -20},
                {"log": "Found excellent deal on warehouse space!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -30},
                {"log": "Expansion completed but at standard cost."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -40},
                {"log": "Construction problems! Cost overruns."}
              ]
            }
          }
        }
      ]
    },

    {
      "id": "core.shop:shop:t2",
      "name": "Trading House",
      "description": "A well-established merchant operation with broader market reach.",
      "tier": 2,
      "parent": "core.shop:shop:t1",
      "build": {
        "cost": {"gold": 500},
        "duration_turns": 2
      },
      "npc_slots": 2,
      "npc_allowed_professions": ["merchant", "trader", "shopkeeper", "appraiser"],
      "npc_base_upkeep": {"silver": 10},

      "orders": [
        {
          "id": "negotiate_contracts",
          "name": "Negotiate Trade Contracts",
          "description": "Establish long-term supplier or buyer relationships for better rates.",
          "min_npc_level": 2,
          "duration_turns": 2,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -20},
                {"item": "trade_contract", "qty": 1},
                {"log": "Secured favorable trade contract. Future deals improved."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -10},
                {"item": "exclusive_contract", "qty": 1},
                {"gold": 30},
                {"log": "Exclusive deal! Immediate signing bonus received."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -20},
                {"log": "Negotiations inconclusive."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -30},
                {"log": "Negotiations broke down badly. Lost potential partner and wasted time."}
              ]
            }
          }
        },
        {
          "id": "hire_appraiser",
          "name": "Hire Expert Appraiser",
          "description": "Temporarily employ a specialist to better evaluate rare goods.",
          "min_npc_level": 2,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -15},
                {"gold": 40},
                {"log": "Appraiser identified undervalued goods. Excellent profits!"}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -15},
                {"gold": 80},
                {"item": "rare_artifact", "qty": 1},
                {"log": "Discovered a hidden treasure among common goods!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -15},
                {"log": "Appraiser found nothing of note."}
              ]
            }
          }
        },
        {
          "id": "establish_caravan_route",
          "name": "Establish Caravan Route",
          "description": "Set up trade route to distant markets for exotic goods.",
          "min_npc_level": 2,
          "duration_turns": 4,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -50},
                {"gold": 100},
                {"log": "Caravan route established. Regular exotic goods available."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -50},
                {"gold": 200},
                {"item": "trade_route_map", "qty": 1},
                {"log": "Discovered profitable shortcut! Exceptional trade route."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -50},
                {"gold": 40},
                {"log": "Route difficult to maintain. Slim profits."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -50},
                {"gold": -30},
                {"log": "Caravan lost to bandits! Total loss."}
              ]
            }
          }
        },
        {
          "id": "corner_market",
          "name": "Corner the Market",
          "description": "Attempt to monopolize a category through aggressive buying.",
          "min_npc_level": 3,
          "duration_turns": 3,
          "outcome": {
            "check_profile": "d20_hard",
            "on_success": {
              "effects": [
                {"gold": -100},
                {"log": "Successfully cornered market! Control prices in this category for several turns."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -100},
                {"gold": 200},
                {"log": "Total market domination! Massive profits from price control."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -100},
                {"log": "Competitors resisted. Market corner failed."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -100},
                {"gold": -50},
                {"log": "Rival merchants formed coalition against you! Major losses."}
              ]
            }
          }
        }
      ]
    },

    {
      "id": "core.shop:shop:t3",
      "name": "Grand Emporium",
      "description": "A legendary trading empire with influence across multiple regions.",
      "tier": 3,
      "parent": "core.shop:shop:t2",
      "build": {
        "cost": {"gold": 1000},
        "duration_turns": 3
      },
      "npc_slots": 3,
      "npc_allowed_professions": ["merchant", "trader", "appraiser", "merchant_prince"],
      "npc_base_upkeep": {"gold": 1},

      "orders": [
        {
          "id": "establish_monopoly",
          "name": "Establish Trade Monopoly",
          "description": "Secure exclusive rights to trade in a category across the entire region.",
          "min_npc_level": 3,
          "duration_turns": 8,
          "outcome": {
            "check_profile": "d20_hard",
            "on_success": {
              "effects": [
                {"gold": -300},
                {"item": "monopoly_charter", "qty": 1},
                {"log": "Royal charter granted! Complete control over category pricing."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -300},
                {"item": "royal_monopoly_charter", "qty": 1},
                {"gold": 500},
                {"log": "The crown itself endorses your monopoly! Unprecedented profits."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -300},
                {"log": "Political opposition too strong. Monopoly denied."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -300},
                {"gold": -150},
                {"log": "Scandal! Accusations of bribery. Massive fines and reputation damage."}
              ]
            }
          }
        }
      ]
    }
  ]
}