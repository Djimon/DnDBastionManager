{
  "pack_id": "core.extended.shop",
  "name": "Storehouse & Trading Post",
  "version": 1,
  "author": "Djih",
  "custom_mechanics": [
    {
      "name": "Market Tracker",
      "type": "market_tracker",
      "config": {
        "categories": [
          {
            "name": "weapons",
            "start": 11
          },
          {
            "name": "armor",
            "start": 7
          },
          {
            "name": "potions",
            "start": -3
          },
          {
            "name": "tools",
            "start": 0
          },
          {
            "name": "jewelry",
            "start": -5
          }
        ],
        "price_range": [
          -0.2,
          0.2
        ]
      }
    },
    {
      "name": "Shop Trading",
      "type": "formula_engine",
      "config": {
        "inputs": [
          {
            "name": "weapons_market",
            "source": "number",
            "label": "Weapons Market (%)"
          },
          {
            "name": "armor_market",
            "source": "number",
            "label": "Armor Market (%)"
          },
          {
            "name": "potions_market",
            "source": "number",
            "label": "Potions Market (%)"
          },
          {
            "name": "tools_market",
            "source": "number",
            "label": "Tools Market (%)"
          },
          {
            "name": "jewelry_market",
            "source": "number",
            "label": "jewelry Market (%)"
          },
          {
            "name": "weapons_sell",
            "source": "number",
            "label": "SELL Weapons at markup (%, 0=skip)"
          },
          {
            "name": "armor_sell",
            "source": "number",
            "label": "SELL Armor at markup (%, 0=skip)"
          },
          {
            "name": "potions_sell",
            "source": "number",
            "label": "SELL Potions at markup (%, 0=skip)"
          },
          {
            "name": "tools_sell",
            "source": "number",
            "label": "SELL Tools at markup (%, 0=skip)"
          },
          {
            "name": "jewelry_sell",
            "source": "number",
            "label": "SELL jewelry at markup (%, 0=skip)"
          },
          {
            "name": "weapons_buy",
            "source": "number",
            "label": "BUY Weapons at discount (%, 0=skip)"
          },
          {
            "name": "armor_buy",
            "source": "number",
            "label": "BUY Armor at discount (%, 0=skip)"
          },
          {
            "name": "potions_buy",
            "source": "number",
            "label": "BUY Potions at discount (%, 0=skip)"
          },
          {
            "name": "tools_buy",
            "source": "number",
            "label": "BUY Tools at discount (%, 0=skip)"
          },
          {
            "name": "jewelry_buy",
            "source": "number",
            "label": "BUY jewelry at discount (%, 0=skip)"
          },
          {
            "name": "base_volume",
            "source": "number",
            "default": 100,
            "label": "Base Trade Volume (GP)"
          }
        ],
        "calculations": [
          {
            "name": "weapons_sell_profit",
            "conditions": [
              {
                "if": "weapons_sell > 0",
                "then_formula": "base_volume * (weapons_market - weapons_sell) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "weapons_buy_cost",
            "conditions": [
              {
                "if": "weapons_buy > 0",
                "then_formula": "-base_volume * (weapons_market + weapons_buy) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "weapons_total",
            "formula": "weapons_sell_profit + weapons_buy_cost"
          },
          {
            "name": "armor_sell_profit",
            "conditions": [
              {
                "if": "armor_sell > 0",
                "then_formula": "base_volume * (armor_market - armor_sell) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "armor_buy_cost",
            "conditions": [
              {
                "if": "armor_buy > 0",
                "then_formula": "-base_volume * (armor_market + armor_buy) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "armor_total",
            "formula": "armor_sell_profit + armor_buy_cost"
          },
          {
            "name": "potions_sell_profit",
            "conditions": [
              {
                "if": "potions_sell > 0",
                "then_formula": "base_volume * (potions_market - potions_sell) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "potions_buy_cost",
            "conditions": [
              {
                "if": "potions_buy > 0",
                "then_formula": "-base_volume * (potions_market + potions_buy) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "potions_total",
            "formula": "potions_sell_profit + potions_buy_cost"
          },
          {
            "name": "tools_sell_profit",
            "conditions": [
              {
                "if": "tools_sell > 0",
                "then_formula": "base_volume * (tools_market - tools_sell) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "tools_buy_cost",
            "conditions": [
              {
                "if": "tools_buy > 0",
                "then_formula": "-base_volume * (tools_market + tools_buy) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "tools_total",
            "formula": "tools_sell_profit + tools_buy_cost"
          },
          {
            "name": "jewelry_sell_profit",
            "conditions": [
              {
                "if": "jewelry_sell > 0",
                "then_formula": "base_volume * (jewelry_market - jewelry_sell) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "jewelry_buy_cost",
            "conditions": [
              {
                "if": "jewelry_buy > 0",
                "then_formula": "-base_volume * (jewelry_market + jewelry_buy) / 100"
              },
              {
                "else": 0
              }
            ]
          },
          {
            "name": "jewelry_total",
            "formula": "jewelry_sell_profit + jewelry_buy_cost"
          },
          {
            "name": "total_profit",
            "formula": "weapons_total + armor_total + potions_total + tools_total + jewelry_total"
          }
        ],
        "effects": [
          {
            "gold": "${total_profit}"
          }
        ]
      }
    }
  ],
  "facilities": [
    {
      "id": "core.shop:shop:t1",
      "name": "Storehouse",
      "description": "A modest trading post for buying and selling common goods.",
      "tier": 1,
      "parent": null,
      "build": {
        "cost": {
          "gold": 250
        },
        "duration_turns": 1
      },
      "npc_slots": 1,
      "npc_allowed_professions": [
        "merchant",
        "trader",
        "shopkeeper"
      ],
      "npc_base_upkeep": {
        "silver": 5
      },
      "orders": [
        {
          "id": "trade_turn",
          "name": "Execute Trading Turn",
          "description": "Trade goods based on market conditions and your pricing strategy.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {
                  "log": "Trading completed. Shop Trading formula applied."
                },
                {
                  "gold": 10
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "log": "Exceptional negotiations! Bonus profits from savvy deals."
                },
                {
                  "gold": 20
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Some deals fell through. Minor losses."
                }
              ]
            },
            "on_critical_failure": {
              "effects": [
                {
                  "log": "Catastrophic misjudgment! Major trading losses."
                }
              ]
            }
          }
        },
        {
          "id": "gather_market_intel",
          "name": "Gather Market Intelligence",
          "description": "Send scouts to observe market trends and competitor pricing.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {
                  "item": "market_report",
                  "qty": 1
                },
                {
                  "log": "Gathered useful market information."
                },
                {
                  "gold": -5
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "item": "detailed_market_report",
                  "qty": 1
                },
                {
                  "log": "Excellent intelligence! Discovered upcoming market shifts."
                },
                {
                  "gold": -5
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Market information unclear this week."
                },
                {
                  "gold": -5
                }
              ]
            }
          }
        },
        {
          "id": "expand_inventory",
          "name": "Expand Inventory Capacity",
          "description": "Invest in storage to increase base trading volume.",
          "min_npc_level": 2,
          "duration_turns": 2,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {
                  "log": "Storage expanded. Base volume permanently increased."
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "log": "Found excellent deal on warehouse space!"
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Expansion completed but at standard cost."
                }
              ]
            },
            "on_critical_failure": {
              "effects": [
                {
                  "log": "Construction problems! Cost overruns."
                }
              ]
            }
          }
        }
      ]
    },
    {
      "id": "core.shop:shop:t2",
      "name": "Trading House",
      "description": "A well-established merchant operation with broader market reach.",
      "tier": 2,
      "parent": "core.shop:shop:t1",
      "build": {
        "cost": {
          "gold": 500
        },
        "duration_turns": 2
      },
      "npc_slots": 2,
      "npc_allowed_professions": [
        "merchant",
        "trader",
        "shopkeeper",
        "appraiser"
      ],
      "npc_base_upkeep": {
        "silver": 10
      },
      "orders": [
        {
          "id": "negotiate_contracts",
          "name": "Negotiate Trade Contracts",
          "description": "Establish long-term supplier or buyer relationships for better rates.",
          "min_npc_level": 2,
          "duration_turns": 2,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {
                  "item": "trade_contract",
                  "qty": 1
                },
                {
                  "log": "Secured favorable trade contract. Future deals improved."
                },
                {
                  "gold": -20
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "item": "exclusive_contract",
                  "qty": 1
                },
                {
                  "log": "Exclusive deal! Immediate signing bonus received."
                },
                {
                  "gold": -20
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Negotiations inconclusive."
                },
                {
                  "gold": -20
                }
              ]
            },
            "on_critical_failure": {
              "effects": [
                {
                  "log": "Negotiations broke down badly. Lost potential partner and wasted time."
                },
                {
                  "gold": -20
                }
              ]
            }
          }
        },
        {
          "id": "hire_appraiser",
          "name": "Hire Expert Appraiser",
          "description": "Temporarily employ a specialist to better evaluate rare goods.",
          "min_npc_level": 2,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {
                  "log": "Appraiser identified undervalued goods. Excellent profits!"
                },
                {
                  "gold": -15
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "item": "magic_item",
                  "qty": 1
                },
                {
                  "log": "Discovered a hidden treasure among common goods!"
                },
                {
                  "gold": -15
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Appraiser found nothing of note."
                },
                {
                  "gold": -15
                }
              ]
            }
          }
        },
        {
          "id": "establish_caravan_route",
          "name": "Establish Caravan Route",
          "description": "Set up trade route to distant markets for exotic goods.",
          "min_npc_level": 2,
          "duration_turns": 4,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {
                  "log": "Caravan route established. Regular exotic goods available."
                },
                {
                  "gold": -50
                },
                {
                  "gold": 60
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "item": "trade_route_map",
                  "qty": 1
                },
                {
                  "log": "Discovered profitable shortcut! Exceptional trade route."
                },
                {
                  "gold": -50
                },
                {
                  "gold": 120
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Route difficult to maintain. Slim profits."
                },
                {
                  "gold": -50
                }
              ]
            },
            "on_critical_failure": {
              "effects": [
                {
                  "log": "Caravan lost to bandits! Total loss."
                },
                {
                  "gold": -50
                }
              ]
            }
          }
        },
        {
          "id": "corner_market",
          "name": "Corner the Market",
          "description": "Attempt to monopolize a category through aggressive buying.",
          "min_npc_level": 3,
          "duration_turns": 3,
          "outcome": {
            "check_profile": "d20_hard",
            "on_success": {
              "effects": [
                {
                  "log": "Successfully cornered market! Control prices in this category for several turns."
                },
                {
                  "gold": 120
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "log": "Total market domination! Massive profits from price control."
                },
                {
                  "gold": 200
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Competitors resisted. Market corner failed."
                }
              ]
            },
            "on_critical_failure": {
              "effects": [
                {
                  "log": "Rival merchants formed coalition against you! Major losses."
                }
              ]
            }
          }
        }
      ]
    },
    {
      "id": "core.shop:shop:t3",
      "name": "Grand Emporium",
      "description": "A legendary trading empire with influence across multiple regions.",
      "tier": 3,
      "parent": "core.shop:shop:t2",
      "build": {
        "cost": {
          "gold": 1000
        },
        "duration_turns": 3
      },
      "npc_slots": 3,
      "npc_allowed_professions": [
        "merchant",
        "trader",
        "appraiser",
        "merchant_prince"
      ],
      "npc_base_upkeep": {
        "gold": 1
      },
      "orders": [
        {
          "id": "establish_monopoly",
          "name": "Establish Trade Monopoly",
          "description": "Secure exclusive rights to trade in a category across the entire region.",
          "min_npc_level": 3,
          "duration_turns": 8,
          "outcome": {
            "check_profile": "d20_hard",
            "on_success": {
              "effects": [
                {
                  "item": "monopoly_charter",
                  "qty": 1
                },
                {
                  "log": "Royal charter granted! Complete control over category pricing."
                },
                {
                  "gold": -300
                },
                {
                  "gold": 200
                }
              ]
            },
            "on_critical_success": {
              "effects": [
                {
                  "item": "royal_monopoly_charter",
                  "qty": 1
                },
                {
                  "log": "The crown itself endorses your monopoly! Unprecedented profits."
                },
                {
                  "gold": -300
                },
                {
                  "gold": 250
                }
              ]
            },
            "on_failure": {
              "effects": [
                {
                  "log": "Political opposition too strong. Monopoly denied."
                },
                {
                  "gold": -300
                }
              ]
            },
            "on_critical_failure": {
              "effects": [
                {
                  "gold": -150
                },
                {
                  "log": "Scandal! Accusations of bribery. Massive fines and reputation damage."
                },
                {
                  "gold": -300
                }
              ]
            }
          }
        }
      ]
    }
  ]
}
