{
  "pack_id": "core.extended.pub",
  "name": "Pub",
  "version": 1,
  "author": "Djih",

  "custom_mechanics": [
    {
      "name": "Reputation",
      "type": "stat_counter",
      "config": {
        "custom_stat_name": "reputation",
        "min_value": 0,
        "max_value": 20
      }
    },
    {
      "name": "Pub Management",
      "type": "formula_engine",
      "config": {
        "inputs": [
          { "name": "drink_stock", "source": "item", "default": "beer", "label": "Primary Drink"},
          { "name": "food_stock", "source": "item", "default": "food", "label": "Food Item "},
          { "name": "reputation_stat", "source": "stat", "default": "reputation", "label": "Reputation Stat"},
          { "name": "base_income", "source": "fixed", "default": 10, "label": "Base Income Multiplier"},
          { "name": "base_cost", "source": "currency", "default": {"gold": -5}, "label": "Base Cost"}
        ],
        "calculations": [
          {
            "name": "consumption",
            "formula": "1d6+reputation_stat"
          },
          {
            "name": "beer_satisfaction",
            "formula": "drink_stock - consumption"
          },
          {
            "name": "food_satisfaction",
            "formula": "food_stock - consumption"
          },
          {
            "name": "total_satisfaction",
            "formula": "beer_satisfaction + food_satisfaction"
          },
          {
            "name": "final_income",
            "formula": "total_satisfaction * base_income - base_cost"
          },
          {
            "name": "reputation_delta",
            "conditions": [
              {"if": "total_satisfaction < 0", "then": -1},
              {"if": "total_satisfaction > 10", "then": 1},
              {"else": 0}
            ]
          }
        ],
        "effects": [
          {"item": "${drink_stock}", "qty": "-${consumption}"},
          {"item": "${food_stock}", "qty": "-${consumption}"},
          {"gold": "${final_income}"},
          {"stat": "${reputation_stat}", "delta": "${reputation_delta}"}
        ]
      }
    }
  ],

  "facilities": [
    {
      "id": "core.pub:pub:t1",
      "name": "Pub",
      "description": "A cozy establishment serving food and drink to locals and travelers.",
      "tier": 1,
      "parent": null,
      "build": {
        "cost": {"gold": 250},
        "duration_turns": 1
      },
      "npc_slots": 1,
      "npc_allowed_professions": ["innkeeper", "bartender", "cook"],
      "npc_base_upkeep": {"silver": 5},

      "orders": [
        {
          "id": "serve_customers",
          "name": "Serve Customers",
          "description": "Run the pub for the week, serving food and drinks.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"log": "Normal business week. Pub management formula applied."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": 20},
                {"log": "Exceptional service! Bonus tips from satisfied customers."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -5},
                {"log": "Poor service this week. Some refunds issued."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -15},
                {"stat": "reputation", "delta": -2},
                {"log": "Disaster! A fight broke out and the pub was damaged."}
              ]
            }
          }
        },
        {
          "id": "restock_supplies",
          "name": "Restock Supplies",
          "description": "Purchase beer and food to replenish inventory.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -20},
                {"item": "beer", "qty": 10},
                {"item": "food", "qty": 10},
                {"log": "Supplies restocked at standard prices."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -15},
                {"item": "beer", "qty": 12},
                {"item": "food", "qty": 12},
                {"log": "Great deal from supplier! Extra stock at discount."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -20},
                {"item": "beer", "qty": 8},
                {"item": "food", "qty": 8},
                {"log": "Limited stock available this week."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -25},
                {"item": "beer", "qty": 5},
                {"item": "food", "qty": 5},
                {"log": "Supply shortage! Paid premium for limited stock."}
              ]
            }
          }
        },
        {
          "id": "spread_word",
          "name": "Spread the Word",
          "description": "Advertise the pub to attract more customers and build reputation.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -5},
                {"stat": "reputation", "delta": 1},
                {"log": "Word spreads about the pub. Reputation increases."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -5},
                {"stat": "reputation", "delta": 3},
                {"log": "Your pub becomes the talk of the town!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -5},
                {"log": "Advertising efforts have little effect."}
              ]
            }
          }
        },
        {
          "id": "gather_rumors",
          "name": "Gather Rumors",
          "description": "Listen to customer gossip to collect information and stories.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"item": "rumor", "qty": 2},
                {"log": "Overheard interesting gossip from the patrons."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"item": "rumor", "qty": 3},
                {"item": "valuable_secret", "qty": 1},
                {"log": "A patron let slip something very valuable!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"log": "Nothing interesting overheard this week."}
              ]
            }
          }
        },
        {
          "id": "host_small_event",
          "name": "Host Small Event",
          "description": "Organize a small gathering like a bard's performance or game night.",
          "min_npc_level": 2,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -10},
                {"item": "beer", "qty": -5},
                {"item": "food", "qty": -3},
                {"gold": 30},
                {"stat": "reputation", "delta": 1},
                {"log": "The event was a success! Good profits and happy customers."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -10},
                {"item": "beer", "qty": -5},
                {"item": "food", "qty": -3},
                {"gold": 60},
                {"stat": "reputation", "delta": 3},
                {"log": "Legendary event! People are still talking about it."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -10},
                {"item": "beer", "qty": -5},
                {"item": "food", "qty": -3},
                {"gold": 15},
                {"log": "Event was mediocre. Barely broke even."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -10},
                {"item": "beer", "qty": -5},
                {"item": "food", "qty": -3},
                {"stat": "reputation", "delta": -2},
                {"log": "Event was a disaster! Patrons left disappointed."}
              ]
            }
          }
        }
      ]
    },

    {
      "id": "core.pub:pub:t2",
      "name": "Tavern",
      "description": "A larger and more popular establishment with rooms for rent and entertainment.",
      "tier": 2,
      "parent": "core.pub:pub:t1",
      "build": {
        "cost": {"gold": 500},
        "duration_turns": 2
      },
      "npc_slots": 2,
      "npc_allowed_professions": ["innkeeper", "bartender", "cook", "entertainer"],
      "npc_base_upkeep": {"silver": 10},

      "orders": [
        {
          "id": "rent_rooms",
          "name": "Rent Rooms",
          "description": "Offer lodging to travelers and adventurers.",
          "min_npc_level": 1,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": 25},
                {"log": "Rooms rented to travelers. Steady income."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": 50},
                {"item": "valuable_tip", "qty": 1},
                {"log": "A wealthy noble stayed and left a generous tip!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": 10},
                {"log": "Few travelers this week."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -15},
                {"stat": "reputation", "delta": -1},
                {"log": "A guest complained about bedbugs! Reputation damaged."}
              ]
            }
          }
        },
        {
          "id": "host_tournament",
          "name": "Host Tournament",
          "description": "Organize a competitive event like darts, arm wrestling, or cards.",
          "min_npc_level": 2,
          "duration_turns": 2,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -30},
                {"item": "beer", "qty": -10},
                {"item": "food", "qty": -10},
                {"gold": 80},
                {"stat": "reputation", "delta": 2},
                {"log": "Tournament was a huge success! Great turnout."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -30},
                {"item": "beer", "qty": -10},
                {"item": "food", "qty": -10},
                {"gold": 150},
                {"stat": "reputation", "delta": 5},
                {"item": "champion_trophy", "qty": 1},
                {"log": "Legendary tournament! Famous adventurers participated. Your tavern is now renowned!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -30},
                {"item": "beer", "qty": -10},
                {"item": "food", "qty": -10},
                {"gold": 40},
                {"log": "Tournament had decent attendance but nothing special."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -30},
                {"item": "beer", "qty": -10},
                {"item": "food", "qty": -10},
                {"gold": -20},
                {"stat": "reputation", "delta": -3},
                {"log": "Tournament turned into a brawl! Major damage and reputation loss."}
              ]
            }
          }
        },
        {
          "id": "hire_entertainer",
          "name": "Hire Entertainer",
          "description": "Bring in a bard, musician, or performer to attract customers.",
          "min_npc_level": 2,
          "duration_turns": 1,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"gold": -15},
                {"gold": 40},
                {"stat": "reputation", "delta": 1},
                {"log": "The entertainment draws a good crowd."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -15},
                {"gold": 80},
                {"stat": "reputation", "delta": 3},
                {"log": "A famous bard performed! The tavern is packed for weeks."}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -15},
                {"gold": 20},
                {"log": "The performer was mediocre. Barely covered the cost."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -15},
                {"stat": "reputation", "delta": -1},
                {"log": "The performer was terrible! Customers left early."}
              ]
            }
          }
        },
        {
          "id": "special_brew",
          "name": "Create Special Brew",
          "description": "Craft a unique signature drink to set the tavern apart.",
          "min_npc_level": 3,
          "duration_turns": 2,
          "outcome": {
            "check_profile": "d20",
            "on_success": {
              "effects": [
                {"item": "rare_ingredients", "qty": -1},
                {"gold": -10},
                {"item": "signature_brew", "qty": 5},
                {"stat": "reputation", "delta": 2},
                {"log": "The special brew is a hit! Customers love it."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"item": "rare_ingredients", "qty": -1},
                {"gold": -10},
                {"item": "legendary_brew", "qty": 3},
                {"stat": "reputation", "delta": 5},
                {"gold": 50},
                {"log": "You've created a legendary drink! Nobles travel from afar to taste it!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"item": "rare_ingredients", "qty": -1},
                {"gold": -10},
                {"item": "mediocre_brew", "qty": 2},
                {"log": "The brew is drinkable but nothing special."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"item": "rare_ingredients", "qty": -1},
                {"gold": -10},
                {"stat": "reputation", "delta": -2},
                {"log": "The brew made people sick! Reputation damaged."}
              ]
            }
          }
        }
      ]
    },

    {
      "id": "core.pub:pub:t3",
      "name": "Grand Inn",
      "description": "A prestigious establishment known throughout the region for its hospitality and entertainment.",
      "tier": 3,
      "parent": "core.pub:pub:t2",
      "build": {
        "cost": {"gold": 1000},
        "duration_turns": 3
      },
      "npc_slots": 3,
      "npc_allowed_professions": ["innkeeper", "bartender", "cook", "entertainer", "host"],
      "npc_base_upkeep": {"gold": 1},

      "orders": [
        {
          "id": "host_royal_banquet",
          "name": "Host Royal Banquet",
          "description": "Organize a lavish feast for nobility and important figures.",
          "min_npc_level": 3,
          "duration_turns": 4,
          "outcome": {
            "check_profile": "d20_hard",
            "on_success": {
              "effects": [
                {"gold": -100},
                {"item": "rare_wine", "qty": -5},
                {"item": "exotic_food", "qty": -10},
                {"gold": 300},
                {"stat": "reputation", "delta": 10},
                {"log": "The banquet was magnificent! Your inn is now famous across the realm."}
              ]
            },
            "on_critical_success": {
              "effects": [
                {"gold": -100},
                {"item": "rare_wine", "qty": -5},
                {"item": "exotic_food", "qty": -10},
                {"gold": 500},
                {"stat": "reputation", "delta": 20},
                {"item": "royal_patronage", "qty": 1},
                {"log": "The king himself attended! You've earned royal patronage!"}
              ]
            },
            "on_failure": {
              "effects": [
                {"gold": -100},
                {"item": "rare_wine", "qty": -5},
                {"item": "exotic_food", "qty": -10},
                {"gold": 150},
                {"stat": "reputation", "delta": 3},
                {"log": "The banquet was acceptable but not exceptional."}
              ]
            },
            "on_critical_failure": {
              "effects": [
                {"gold": -100},
                {"item": "rare_wine", "qty": -5},
                {"item": "exotic_food", "qty": -10},
                {"gold": -50},
                {"stat": "reputation", "delta": -10},
                {"log": "Catastrophic failure! Food poisoning at the banquet. Your reputation is in ruins!"}
              ]
            }
          }
        }
      ]
    }
  ]
}